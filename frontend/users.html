<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SellerGen AI â€“ Users Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex overflow-hidden">

<!-- Sidebar -->
<aside class="w-64 bg-slate-900 text-gray-200 flex flex-col h-screen">
  <div class="p-5 text-xl font-bold text-emerald-400 border-b border-slate-700">
    SellerGen AI
  </div>

  <nav class="flex-1 overflow-y-auto p-4 space-y-2">
    <a href="/admin" data-page="dashboard"
       class="menu-item block px-4 py-2 rounded-lg">ðŸ“Š Dashboard</a>
    <a href="/users" data-page="users"
       class="menu-item block px-4 py-2 rounded-lg">ðŸ‘¥ Users</a>
    <a href="#" data-page="payments"
       class="menu-item block px-4 py-2 rounded-lg">ðŸ’³ Payments</a>
    <a href="#" data-page="analytics"
       class="menu-item block px-4 py-2 rounded-lg">ðŸ“ˆ Analytics</a>
  </nav>

  <div class="p-4 border-t border-slate-700">
    <button onclick="logout()"
      class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg">
      Logout
    </button>
  </div>
</aside>

<!-- Main -->
<main class="flex-1 overflow-auto">
  <div class="bg-white shadow-sm p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">Users Management</h1>
    <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-sm">
      Admin
    </span>
  </div>

  <div class="p-6 space-y-6">

    <div class="flex gap-3">
      <input id="searchInput" type="text" placeholder="Search by email..."
        class="border px-3 py-2 rounded-lg text-sm w-60">
      <select id="planFilter" class="border px-3 py-2 rounded-lg text-sm">
        <option value="all">All Plans</option>
        <option value="free">Free</option>
        <option value="pro">Pro</option>
      </select>
    </div>

    <div class="bg-white rounded-xl shadow p-4">
      <table class="w-full text-sm text-center">
        <thead class="bg-gray-100">
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Plan</th>
            <th>Usage</th>
            <th>Last Used</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
      <div id="pagination" class="flex justify-center gap-2 mt-4"></div>
    </div>

  </div>
</main>

<!-- Toast -->
<div id="toast"
  class="fixed top-6 right-6 hidden items-center gap-3 px-4 py-3 rounded-xl shadow-xl text-white text-sm z-50">
</div>

<!-- Confirm Modal -->
<div id="confirmModal"
  class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl w-80">
    <h3 class="text-lg font-semibold mb-2">Confirm Delete</h3>
    <p class="text-gray-600 mb-4 text-sm">
      Are you sure you want to delete this user?
    </p>
    <div class="flex justify-end gap-2">
      <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-lg">
        Cancel
      </button>
      <button id="confirmDeleteBtn"
        class="px-4 py-2 bg-red-500 text-white rounded-lg">
        Delete
      </button>
    </div>
  </div>
</div>

<script>
/* -------- Auth -------- */
const token = localStorage.getItem("token");
if (!token) location.href = "/login";

function logout() {
  localStorage.removeItem("token");
  location.href = "/login";
}

/* -------- Toast -------- */
function showToast(message, type="success"){
  const toast = document.getElementById("toast");
  const bg = type === "success"
    ? "bg-gradient-to-r from-emerald-500 to-green-600"
    : "bg-gradient-to-r from-red-500 to-rose-600";

  toast.innerHTML = `${type==="success"?"âœ…":"âŒ"} ${message}`;
  toast.className = `fixed top-6 right-6 flex ${bg}
    px-4 py-3 rounded-xl shadow-xl text-white text-sm z-50`;
  toast.classList.remove("hidden");

  setTimeout(()=>toast.classList.add("hidden"),2500);
}

/* -------- Users + Pagination -------- */
let allUsers = [];
let currentPage = 1;
const usersPerPage = 10;

async function loadUsers(){
  const res = await fetch("/admin/users", {
    headers:{Authorization:"Bearer "+token}
  });
  allUsers = await res.json();
  renderUsers();
}

function renderUsers(){
  const search = searchInput.value.toLowerCase();
  const plan = planFilter.value;

  const filtered = allUsers.filter(u =>
    u.email.toLowerCase().includes(search) &&
    (plan==="all" || u.plan===plan)
  );

  const start = (currentPage-1)*usersPerPage;
  const users = filtered.slice(start,start+usersPerPage);

  usersTable.innerHTML = "";

  users.forEach(u=>{
    const badge = u.plan==="pro"
      ? `<span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">PRO</span>`
      : `<span class="px-2 py-1 rounded-full text-xs bg-slate-200 text-slate-700">FREE</span>`;

    usersTable.innerHTML += `
      <tr class="hover:bg-gray-50">
        <td>${u.id}</td>
        <td>${u.email}</td>
        <td>${badge}</td>
        <td>${u.usage}</td>
        <td>${u.last_used}</td>
        <td>
          <div class="flex gap-2 justify-center">
            <select class="border rounded px-2 py-1 text-xs"
              onchange="setPlan(${u.id},this.value)">
              <option value="">Change Plan</option>
              <option value="free">Free</option>
              <option value="pro">Pro</option>
            </select>
            <button onclick="openModal(${u.id})"
              class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">
              Delete
            </button>
          </div>
        </td>
      </tr>`;
  });

  renderPagination(filtered.length);
}

function renderPagination(total){
  pagination.innerHTML="";
  const pages=Math.ceil(total/usersPerPage);
  for(let i=1;i<=pages;i++){
    pagination.innerHTML+=`
      <button onclick="currentPage=${i};renderUsers()"
        class="px-3 py-1 rounded ${
          i===currentPage?"bg-indigo-500 text-white":"bg-gray-200 hover:bg-gray-300"
        }">${i}</button>`;
  }
}

/* -------- Set Plan -------- */
async function setPlan(id, plan){
  if(!plan) return;

  const res = await fetch(`/admin/set-plan/${id}?plan=${plan}`,{
    method:"POST",
    headers:{Authorization:"Bearer "+token}
  });

  if(res.ok){
    showToast("Plan updated successfully","success");
    loadUsers();
  }else{
    showToast("Failed to update plan","error");
  }
}

/* -------- Delete -------- */
let deleteUserId=null;

function openModal(id){
  deleteUserId=id;
  confirmModal.classList.remove("hidden");
  confirmModal.classList.add("flex");
}

function closeModal(){
  deleteUserId=null;
  confirmModal.classList.add("hidden");
  confirmModal.classList.remove("flex");
}

confirmDeleteBtn.onclick = async ()=>{
  const res = await fetch(`/admin/delete-user/${deleteUserId}`,{
    method:"DELETE",
    headers:{Authorization:"Bearer "+token}
  });
  if(res.ok){
    showToast("User deleted","success");
    closeModal();
    loadUsers();
  }else{
    showToast("Delete failed","error");
  }
};

searchInput.oninput=()=>{currentPage=1;renderUsers();}
planFilter.onchange=()=>{currentPage=1;renderUsers();}

/* -------- Init -------- */
loadUsers();
</script>
</body>
</html>
